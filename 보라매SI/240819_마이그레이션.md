


# 마이그레이션
경찰트라우마 진료의뢰서 테이블이 존재하지 않아, 마이그레이션은 진행한다.

## 참고활 테이블들 조회
### 마이그레이션 할 ASIS 테이블 조회
- ASIS 경찰트라우마 진료의뢰서 테이블
    ```sql
    EXEC :IN_OWNER      := UPPER('HBIL');
    EXEC :IN_TABLE_NAME := UPPER('appoltrt');
    /**/
    SELECT C.COMMENTS COMMENTS_TAB
         , A.COLUMN_ID
         , A.OWNER
         , A.TABLE_NAME
         , A.COLUMN_NAME
         , B.COMMENTS COMMENTS_COL
         , A.DATA_TYPE
         , A.DATA_LENGTH
         , DECODE(A.NULLABLE, 'N', 'Y', NULL) NOTNULL
      FROM ALL_TAB_COLUMNS@DL_ORAMIG A
         , ALL_COL_COMMENTS@DL_ORAMIG B
         , ALL_TAB_COMMENTS@DL_ORAMIG C
     WHERE A.TABLE_NAME = :IN_TABLE_NAME
       AND A.OWNER      = :IN_OWNER
       AND A.OWNER      = B.OWNER
       AND A.TABLE_NAME = B.TABLE_NAME
       AND A.COLUMN_NAME= B.COLUMN_NAME
       AND A.TABLE_NAME = C.TABLE_NAME
       AND A.OWNER = C.OWNER
     ORDER BY COLUMN_ID
    ```

    ![](/보라매SI/img2/2024-08-19마이그레이션1.png)


### 참고할 TOBE에 유사 테이블 조회
- TOBE ONESTOP진료의뢰서정보 테이블
    ```SQL
    EXEC :IN_OWNER      := 'HBIL';
    EXEC :IN_TABLE_NAME := 'ACPPROSD';

    SELECT C.TABLE_NAME
         , C.COMMENTS
         , CASE
               WHEN ROWNUM = 1 THEN 'NULL AS ' || RPAD(A.COLUMN_NAME, 30, ' ') || ' -- ' || LPAD( TO_CHAR(A.COLUMN_ID), 3, '0') || '. ' || B.COMMENTS
               ELSE '     , NULL AS ' || RPAD(A.COLUMN_NAME, 30, ' ') || ' -- ' || LPAD( TO_CHAR(A.COLUMN_ID), 3, '0') || '. ' || B.COMMENTS
           END   AS ABC
         , A.COLUMN_ID
         , A.COLUMN_NAME
         , B.COMMENTS
         , A.DATA_TYPE
         , (CASE WHEN A.DATA_TYPE LIKE '%CHAR%' THEN A.DATA_LENGTH END) AS LENGTH
         , (SELECT 'Y'
              FROM ALL_CONSTRAINTS AA
                 , ALL_CONS_COLUMNS BB
             WHERE AA.TABLE_NAME = A.TABLE_NAME
               AND AA.CONSTRAINT_TYPE ='P'
               AND AA.OWNER = BB.OWNER
               AND AA.CONSTRAINT_NAME = BB.CONSTRAINT_NAME
               AND BB.COLUMN_NAME = A.COLUMN_NAME)  PK
         , DECODE(NULLABLE, 'N', 'Y') NOTNULL
      FROM ALL_TAB_COLUMNS A
         , ALL_COL_COMMENTS B
         , ALL_TAB_COMMENTS C
     WHERE A.TABLE_NAME = :IN_TABLE_NAME
       AND A.OWNER      = :IN_OWNER
       AND A.OWNER      = B.OWNER
       AND A.TABLE_NAME = B.TABLE_NAME
       AND A.COLUMN_NAME= B.COLUMN_NAME
       AND A.OWNER = C.OWNER
       AND A.TABLE_NAME = C.TABLE_NAME
     ORDER BY COLUMN_ID
    ```

    ![](/보라매SI/img2/2024-08-19마이그레이션2.png)


## 테이블 생성

- 경찰트라우마 진료의뢰서 테이블 생성 쿼리
```SQL
CREATE TABLE HBIL.ACPPRPOT(                   --ONESTOP진료의뢰서정보
   HSP_TP_CD       VARCHAR2(2)    NOT NULL    --병원구분코드
  ,PT_NO           VARCHAR2(8)    NOT NULL    --환자번호
  ,REG_DT          DATE           NOT NULL    --등록일자
  ,REG_SEQ         NUMBER         NOT NULL    --등록순번
  --,RFFM_TP_CD      VARCHAR2(2)                --의뢰서구분코드
  ,PT_RRN          VARCHAR2(13)               --환자주민등록번호
  ,POST_NO         VARCHAR2(6)                --우편번호
  ,POST_NO_SEQ     NUMBER                     --우편번호순번
  ,BSC_ADDR        VARCHAR2(120)              --기본주소
  ,DTL_ADDR        VARCHAR2(120)              --상세주소
  ,TEL_NO          VARCHAR2(20)                --전화번호
  ,MTEL_NO         VARCHAR2(20)                --휴대폰번호

  ,PACT_TP_CD      VARCHAR2(1)                 --원무접수구분코드(입원외래구분)
  --,EMRG_KIT_USE_YN VARCHAR2(1)                 --응급키트사용여부
  ,MED_DEPT_CD     VARCHAR2(7)                 --진료과코드
  ,MEDR_STF_NO     VARCHAR2(5)                 --진료의직원번호
  ,MED_DTM         DATE                        --진료일시


  ,PME_CLS_CD      VARCHAR2(2)                 --환자급종유형코드
  ,PSE_CLS_CD      VARCHAR2(3)                 --환자보조유형코드
  
  

  ,FRVS_RMDE_TP_CD VARCHAR2(1)                --초진재진구분코드
  ,CMED_DR_YN      VARCHAR2(1)                --선택진료의사여부
  ,PRNT_RMK_CNTE   VARCHAR2(6)                --출력비고내용
  ,RMK_CNTE        VARCHAR2(4000)             --비고내용
  ,FRVS_CMED_YN    VARCHAR2(1)                --초진선택여부
  ,RMDE_CMED_YN    VARCHAR2(1)                --재진선택여부
  ,EXM_CMED_YN     VARCHAR2(1)                --검사선택여부
  ,DGNS_CMED_YN    VARCHAR2(1)                --진단선택여부
  ,CNCL_DT         DATE                       --취소일자
  ,CNCL_STF_NO     VARCHAR2(5)                --취소직원번호

-- 이 아래 4개 뭐냐?  
  ,BLDG_MGMT_NO    VARCHAR2(50)               --건물관리번호
  ,BOBD_PT_NO      VARCHAR2(8)                --합본이전환자번호
  ,BIND_DTM        DATE                       --합본일시
  ,BIND_STF_NO     VARCHAR2(5)                --합본직원번호

-- ASIS : NEW_ADDR_YN(신주소적용여부) / NEW_ADDR(신주소상세주소) / BUILDING_NO(건물관리번호)

  ,FSR_STF_NO      VARCHAR2(5)    NOT NULL    --최초등록직원번호
  ,FSR_DTM         DATE           NOT NULL    --최초등록일시
  ,FSR_PRGM_NM     VARCHAR2(500)  NOT NULL    --최초등록프로그램명
  ,FSR_IP_ADDR     VARCHAR2(50)   NOT NULL    --최초등록IP주소

  ,LSH_STF_NO      VARCHAR2(5)    NOT NULL    --최종변경직원번호
  ,LSH_DTM         DATE           NOT NULL    --최종변경일시
  ,LSH_PRGM_NM     VARCHAR2(500)  NOT NULL    --최종변경프로그램명
  ,LSH_IP_ADDR     VARCHAR2(50)   NOT NULL    --최종변경IP주소
) TABLESPACE TSBIL_D01;    
```

## 마이그레이션 요청
- 테이블을 만들었다면 마이그레이션을 요청해야한다.
    ```
    쉐어포인트 -> DB작업요청
    ```
    - 재강 책임님 테이블 요청을 참고해보자
        
        [![](/보라매SI/img2/2024-08-19마이그레이션3.png)](http://bcdevsp.brmh.org/_layouts/15/start.aspx#/Lists/23%20DB/AllItems.aspx#InplviewHashf5e54be7-f26b-4c74-a709-85d17f24adcd=FilterField1%3DAuthor-FilterValue1%3D%25EA%25B9%2580%2520%25EC%259E%25AC%25EA%25B0%2595)
        - (<strong style="color:red">위 사진을 클릭하면 들어가진다.</strong>)

        [![](/보라매SI/img2/2024-08-19마이그레이션4.png)](/보라매SI/SQL/240819_재강책임님_알림톡%20테이블%20생성%20스크립트.sql)
        - (<strong style="color:red">위 사진을 클릭하면 들어가진다.</strong>)






## 테이블 데이터 이관 작업?
```SQL
SELECT APPOLTRT.REQ_DTE AS REQ_DTE                      -- 001. 병원구분코드
     , APPOLTRT.PT_NO   AS REQ_SEQ                          -- 002. 환자번호
     , NULL AS REG_DT                         -- 003. 등록일자
     , NULL AS REG_SEQ                        -- 004. 등록순번
     , NULL AS RFFM_TP_CD                     -- 005. 의뢰서구분코드
     , NULL AS PT_RRN                         -- 006. 환자주민등록번호
     , NULL AS POST_NO                        -- 007. 우편번호
     , NULL AS POST_NO_SEQ                    -- 008. 우편번호순번
     , NULL AS BSC_ADDR                       -- 009. 기본주소
     , NULL AS DTL_ADDR                       -- 010. 상세주소
     , NULL AS TEL_NO                         -- 011. 보호자명
     , NULL AS MTEL_NO                        -- 012. 환자관계구분코드
     , NULL AS PACT_TP_CD                     -- 013. 원무접수구분코드
     , NULL AS EMRG_KIT_USE_YN                -- 014. 응급키트사용여부
     , NULL AS MED_DEPT_CD                    -- 015. 진료과코드
     , NULL AS MEDR_STF_NO                    -- 016. 진료의직원번호
     , NULL AS PME_CLS_CD                     -- 017. 환자급종유형코드
     , NULL AS PSE_CLS_CD                     -- 018. 환자보조유형코드
     , NULL AS CMED_DR_YN                     -- 019. 선택진료의사여부
     , NULL AS MED_DTM                        -- 020. 진료일시
     , NULL AS FRVS_RMDE_TP_CD                -- 021. 초진재진구분코드
     , NULL AS PRNT_RMK_CNTE                  -- 022. 출력비고내용
     , NULL AS RMK_CNTE                       -- 023. 비고내용
     , NULL AS FRVS_CMED_YN                   -- 024. 초진선택여부
     , NULL AS RMDE_CMED_YN                   -- 025. 재진선택여부
     , NULL AS EXM_CMED_YN                    -- 026. 검사선택여부
     , NULL AS DGNS_CMED_YN                   -- 027. 진단선택여부
     , NULL AS CNCL_DT                        -- 028. 취소일자
     , NULL AS CNCL_STF_NO                    -- 029. 취소직원번호
     , NULL AS BLDG_MGMT_NO                   -- 030. 건물관리번호
     , NULL AS BOBD_PT_NO                     -- 031. 합본이전환자번호
     , NULL AS BIND_DTM                       -- 032. 합본일시
     , NULL AS BIND_STF_NO                    -- 033. 합본직원번호
     , NULL AS FSR_STF_NO                     -- 034. 최초등록직원번호
     , NULL AS FSR_DTM                        -- 035. 최초등록일시
     , NULL AS FSR_PRGM_NM                    -- 036. 최초등록프로그램명
     , NULL AS FSR_IP_ADDR                    -- 037. 최초등록IP주소
     , NULL AS LSH_IP_ADDR                    -- 038. 최종변경직원번호
     , NULL AS LSH_DTM                        -- 039. 최종변경일시
     , NULL AS LSH_PRGM_NM                    -- 040. 최종변경프로그램명
     , NULL AS LSH_STF_NO                     -- 041. 최종변경IP주소
  FROM ASIS_HBIL.APPOLTRT APPOLTRT
```