


# 1. 진료괍별환자종류별진료실적 쿼리 변환
- pkg_mis_pts_pts_pts02.pc_sel_pts02_income020

```sql
/***********************************************************************************
        *    서비스이름      : pc_sel_pts02_income020
        *    최초 작성일     : 2009.10.22
        *    최초 작성자     :
        *    Description     : 진료과별 환자종류별 진료실적
        *    Input Parameter :
        *    페이지ID        :
        ***********************************************************************************/
procedure pc_sel_pts02_income020 ( in_srchtyp   in   varchar2   --      '1': 진료과별 환자현황, '2': 진료과별 일평균 환자수, '3': 진료과별/의사별 환자현황, '4': 진료과별/의사별 일평균 환자수
                                         , in_yyyy   in   varchar2
                                         , in_selyn     in   varchar2  -- '1' 선택 ,'2' 비선택 ,else 전체
                                     , in_look     in   varchar2  --'1' 외래 ,'2' 입원  ,3 전체
                                         , out_cursor    out  returncursor)
        is
                wk_cursor returncursor;
        begin
        if in_srchtyp = '1' then
                        open wk_cursor for
       select
  -------------------------------------------------------------------
--              case when rank = 1 then --and group_ing = '0'
--                        med_dept_nm
--                   when group_ing = '1' then
--                        '합계'
--                   else  null
--              end        med_dept_nm
-------------------------------------------------------------------
              case when rank = 1 then --and group_ing = '0'
                   case when group_ing = 1 then
                        '합계'
                        else med_dept_nm
                   end
              end                      med_dept_nm

--             decode(group_ing, '1', '합계'
--                             , med_dept_nm)  med_dept_nm
             ,''                             meddr_id
             ,cntall
             ,cnt01
             ,cnt02
             ,cnt03
             ,cnt04
             ,cnt05
             ,cnt06
             ,cnt07
             ,cnt08
             ,cnt09
             ,cnt10
             ,cnt11
             ,cnt12
         from
             (
              select
                     nvl((select
--                                 case when instr(dept_nm,'(') > 0 then
--                                           substr(dept_nm,1,instr(dept_nm,'(')-1)
--                                      else
                                           dept_nm
--                                 end
                            from ccdepart a
                           where dept_cd = med_dept),med_dept)  med_dept_nm
                    ,'' meddr_id
                    ,cntall
                    ,cnt01
                    ,cnt02
                    ,cnt03
                    ,cnt04
                    ,cnt05
                    ,cnt06
                    ,cnt07
                    ,cnt08
                    ,cnt09
                    ,cnt10
                    ,cnt11
                    ,cnt12
                    ,group_ing
                    ,1 rank
                from
                    (
                     select
--                            case when med_dept = 'BCGS' then
--                                      'GS'
--                                 when med_dept in ('HPC1','HPC11') then
--                                      'HPC'
--                                 else
--                                      med_dept
--                            end                                                          med_dept
                            a.med_dept                                                   med_dept
                           ,''                                                           meddr_id
                           ,sum(a.o_cnt+a.i_cnt)                                         cntall
                           ,sum(case when to_char(a.med_dte,'mm') = '01'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt01
                           ,sum(case when to_char(a.med_dte,'mm') = '02'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt02
                           ,sum(case when to_char(a.med_dte,'mm') = '03'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt03
                           ,sum(case when to_char(a.med_dte,'mm') = '04'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt04
                           ,sum(case when to_char(a.med_dte,'mm') = '05'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt05
                           ,sum(case when to_char(a.med_dte,'mm') = '06'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt06
                           ,sum(case when to_char(a.med_dte,'mm') = '07'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt07
                           ,sum(case when to_char(a.med_dte,'mm') = '08'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt08
                           ,sum(case when to_char(a.med_dte,'mm') = '09'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt09
                           ,sum(case when to_char(a.med_dte,'mm') = '10'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt10
                           ,sum(case when to_char(a.med_dte,'mm') = '11'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt11
                           ,sum(case when to_char(a.med_dte,'mm') = '12'  then
                                          a.o_cnt+a.i_cnt
                                     else  0 end)                                        cnt12
--                           ,grouping(case when a.med_dept = 'BCGS' then
--                                               'GS'
--                                          when a.med_dept in ('HPC1','HPC11') then
--                                               'HPC'
--                                          else
--                                               a.med_dept
--                                     end)    group_ing
                           ,grouping(a.med_dept)    group_ing
                       from
                            (
                             select
                                    med_dte
                                   ,med_dept
                                   ,meddr_id
                                   ,case in_selyn
                                         when '1' then
                                              chspcrsv_cnt+jespcrsv_cnt+shrsv_cnt
                                         when '2' then
                                              chunspcrsv_cnt+jeunspcrsv_cnt+shunspcrsv_cnt
                                         else
                                              rsv_cnt+today_cnt
                                    end                      o_cnt
                                   ,0                        i_cnt
                              from apstatmt2
                                  ,(
                                    select to_date(in_yyyy||'0101','yyyymmdd')  star_dte
                                          ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                     last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                else
                                                     trunc(sysdate)-1
                                           end end_dte
                                      from dual
                                   )
                             where med_dte between star_dte  and  end_dte
                               and dtl_typ = '06'
                               and patsite in ('O','E')
                               and case when in_look = '1' then '1'
                                        when in_look = '2' then 'X'
                                        else in_look
                                   end  =  in_look
                             union all
                             select
                                   med_dte
                                  ,med_dept
                                  ,meddr_id
                                  ,0               o_cnt
                                  ,case in_selyn
                                        when '1' then
                                             jespcrcp_cnt
                                        when '2' then
                                             jeunspcrcp_cnt
                                        else
                                             jespcrsv_cnt
                                   end
                              from apstatmt2
                             where med_dte in (
                                               select
                                                      distinct
                                                      case when last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd')) <= trunc(sysdate) -1  then
                                                                last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd'))
                                                           else
                                                                trunc(sysdate) -1
                                                      end
                                                 from dict
                                                where rownum <= 12
                                              )
                               and dtl_typ = 'M01'
                               and patsite = 'I'
                               and wk_key  = '1'
--                               and wd_no not in ('ER99','OR99','OGOB','NB')
                               and case when in_look = '1' then 'X'
                                        when in_look = '2' then '2'
                                        else in_look
                                   end  =  in_look

                            ) a
                      group by
--                               rollup(
--                                       case when a.med_dept = 'BCGS' then
--                                                 'GS'
--                                            when a.med_dept in ('HPC1','HPC11') then
--                                                 'HPC'
--                                            else
--                                                 a.med_dept
--                                       end
--                                     )
                               rollup(a.med_dept)
                      having  sum(a.o_cnt+a.i_cnt) != 0
                    )
             )
                                ;
        elsif in_srchtyp = '2'  then
                        open wk_cursor for
       select
              case when group_ing = '0' then
                        med_dept_nm
                   when group_ing = '1' then
                        '합계'
                   else  null
              end        med_dept_nm
             ,meddr_id
             ,cntall
             ,cnt01
             ,cnt02
             ,cnt03
             ,cnt04
             ,cnt05
             ,cnt06
             ,cnt07
             ,cnt08
             ,cnt09
             ,cnt10
             ,cnt11
             ,cnt12
         from
             (
              select
                     nvl((select
--                                 case when instr(dept_nm,'(') > 0 then
--                                           substr(dept_nm,1,instr(dept_nm,'(')-1)
--                                      else
                                           dept_nm
--                                 end
                            from ccdepart a
                           where dept_cd = med_dept),med_dept)  med_dept_nm
                    ,meddr_id
                    ,cntall
                    ,cnt01
                    ,cnt02
                    ,cnt03
                    ,cnt04
                    ,cnt05
                    ,cnt06
                    ,cnt07
                    ,cnt08
                    ,cnt09
                    ,cnt10
                    ,cnt11
                    ,cnt12
                    ,group_ing
                    ,1      rank
                from
                    (
                     select
--                            case when a.med_dept = 'BCGS' then
--                                      'GS'
--                                 when a.med_dept in ('HPC1','HPC11') then
--                                      'HPC'
--                                 else
--                                      a.med_dept
--                            end                                                          med_dept
                            a.med_dept                                                   med_dept
                           ,''                                                           meddr_id
                           ,
                             case when sum(a.o_cnt) = 0 then 0 else round(sum(a.o_cnt)/c.daycnt_all) end
                             +
                             case when sum(a.i_cnt) = 0 then 0 else round(sum(a.i_cnt)/b.daycnt_all) end      cntall
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '01' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '01'  then a.o_cnt else 0 end)/c.daycnt1)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '01' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '01'  then a.i_cnt else 0 end)/b.daycnt1)
                             end                                                           cnt01
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '02' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '02'  then a.o_cnt else 0 end)/c.daycnt2)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '02' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '02'  then a.i_cnt else 0 end)/b.daycnt2)
                             end                                                           cnt02
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '03' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '03'  then a.o_cnt else 0 end)/c.daycnt3)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '03' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '03'  then a.i_cnt else 0 end)/b.daycnt3)
                             end                                                           cnt03
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '04' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '04'  then a.o_cnt else 0 end)/c.daycnt4)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '04' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '04'  then a.i_cnt else 0 end)/b.daycnt4)
                             end                                                           cnt04
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '05' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '05'  then a.o_cnt else 0 end)/c.daycnt5)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '05' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '05'  then a.i_cnt else 0 end)/b.daycnt5)
                             end                                                           cnt05
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '06' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '06'  then a.o_cnt else 0 end)/c.daycnt6)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '06' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '06'  then a.i_cnt else 0 end)/b.daycnt6)
                             end                                                           cnt06
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '07' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '07'  then a.o_cnt else 0 end)/c.daycnt7)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '07' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '07'  then a.i_cnt else 0 end)/b.daycnt7)
                             end                                                           cnt07
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '08' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '08'  then a.o_cnt else 0 end)/c.daycnt8)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '08' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '08'  then a.i_cnt else 0 end)/b.daycnt8)
                             end                                                           cnt08
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '09' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '09'  then a.o_cnt else 0 end)/c.daycnt9)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '09' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '09'  then a.i_cnt else 0 end)/b.daycnt9)
                             end                                                           cnt09
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '10' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '10'  then a.o_cnt else 0 end)/c.daycnt10)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '10' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '10'  then a.i_cnt else 0 end)/b.daycnt10)
                             end                                                           cnt10
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '11' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '11'  then a.o_cnt else 0 end)/c.daycnt11)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '11' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '11'  then a.i_cnt else 0 end)/b.daycnt11)
                             end                                                           cnt11
                           ,
                             case when sum(case when to_char(a.med_dte,'mm') = '12' then a.o_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '12'  then a.o_cnt else 0 end)/c.daycnt12)
                             end
                             +
                             case when sum(case when to_char(a.med_dte,'mm') = '12' then a.i_cnt else 0 end) = 0 then
                                       0
                                  else round(sum(case when to_char(a.med_dte,'mm') = '12'  then a.i_cnt else 0 end)/b.daycnt12)
                             end                                                           cnt12
--                           ,grouping(case when a.med_dept = 'BCGS' then
--                                               'GS'
--                                          when a.med_dept in ('HPC1','HPC11') then
--                                               'HPC'
--                                          else
--                                               a.med_dept
--                                     end)    group_ing
                           ,grouping(a.med_dept)    group_ing
                       from
                            (
                             select
                                    med_dte
                                   ,med_dept
                                   ,meddr_id
                                   ,case in_selyn
                                         when '1' then
                                              chspcrsv_cnt+jespcrsv_cnt+shrsv_cnt
                                         when '2' then
                                              chunspcrsv_cnt+jeunspcrsv_cnt+shunspcrsv_cnt
                                         else
                                              rsv_cnt+today_cnt
                                    end                      o_cnt
                                   ,0                        i_cnt
                              from apstatmt2
                                  ,(
                                    select to_date(in_yyyy||'0101','yyyymmdd')  star_dte
                                          ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                     last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                else
                                                     trunc(sysdate)-1
                                           end end_dte
                                      from dual
                                   )
                             where med_dte between star_dte  and  end_dte
                               and dtl_typ = '06'
                               and patsite in ('O','E')
                               and case when in_look = '1' then '1'
                                        when in_look = '2' then 'X'
                                        else in_look
                                   end  =  in_look
                             union all
                             select
                                   med_dte
                                  ,med_dept
                                  ,meddr_id
                                  ,0               o_cnt
                                  ,case in_selyn
                                        when '1' then
                                             jespcrcp_cnt
                                        when '2' then
                                             jeunspcrcp_cnt
                                        else
                                             jespcrsv_cnt
                                   end
                              from apstatmt2
                             where med_dte in (
                                               select
                                                      distinct
                                                      case when last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd')) <= trunc(sysdate) -1  then
                                                                last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd'))
                                                           else
                                                                trunc(sysdate) -1
                                                      end
                                                 from dict
                                                where rownum <= 12
                                              )
                               and dtl_typ = 'M01'
                               and patsite = 'I'
                               and wk_key  = '1'
--                               and wd_no not in ('ER99','OR99','OGOB','NB')
                               and case when in_look = '1' then 'X'
                                        when in_look = '2' then '2'
                                        else in_look
                                   end  =  in_look
                            ) a
                            ,
                            (
                             select
                                     ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt_all
                                    ,ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0101','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0101','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt1
                                   ,ft_cnt_opday(to_date(in_yyyy||'0201','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0201','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0201','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt2
                                   ,ft_cnt_opday(to_date(in_yyyy||'0301','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0301','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0301','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt3
                                   ,ft_cnt_opday(to_date(in_yyyy||'0401','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0401','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0401','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt4
                                   ,ft_cnt_opday(to_date(in_yyyy||'0501','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0501','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0501','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt5
                                   ,ft_cnt_opday(to_date(in_yyyy||'0601','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0601','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0601','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt6
                                   ,ft_cnt_opday(to_date(in_yyyy||'0701','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0701','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0701','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt7
                                   ,ft_cnt_opday(to_date(in_yyyy||'0801','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0801','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0801','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt8
                                   ,ft_cnt_opday(to_date(in_yyyy||'0901','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0901','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0901','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt9
                                   ,ft_cnt_opday(to_date(in_yyyy||'1001','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1001','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1001','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt10
                                   ,ft_cnt_opday(to_date(in_yyyy||'1101','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1101','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1101','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt11
                                   ,ft_cnt_opday(to_date(in_yyyy||'1201','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'1')               daycnt12
                               from
                                    dual
                             ) b
                            ,
                            (
                             select
                                    ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt_all
                                   ,ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0101','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0101','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt1
                                   ,ft_cnt_opday(to_date(in_yyyy||'0201','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0201','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0201','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt2
                                   ,ft_cnt_opday(to_date(in_yyyy||'0301','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0301','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0301','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt3
                                   ,ft_cnt_opday(to_date(in_yyyy||'0401','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0401','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0401','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt4
                                   ,ft_cnt_opday(to_date(in_yyyy||'0501','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0501','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0501','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt5
                                   ,ft_cnt_opday(to_date(in_yyyy||'0601','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0601','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0601','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt6
                                   ,ft_cnt_opday(to_date(in_yyyy||'0701','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0701','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0701','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt7
                                   ,ft_cnt_opday(to_date(in_yyyy||'0801','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0801','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0801','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt8
                                   ,ft_cnt_opday(to_date(in_yyyy||'0901','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'0901','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'0901','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt9
                                   ,ft_cnt_opday(to_date(in_yyyy||'1001','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1001','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1001','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt10
                                   ,ft_cnt_opday(to_date(in_yyyy||'1101','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1101','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1101','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt11
                                   ,ft_cnt_opday(to_date(in_yyyy||'1201','yyyymmdd')
                                                ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                           last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                      else
                                                           trunc(sysdate)-1
                                                 end
                                                ,'3')               daycnt12
                               from
                                    dual
                            ) c
                       group by
--                               rollup(
--                                       case when a.med_dept = 'BCGS' then
--                                                 'GS'
--                                            when a.med_dept in ('HPC1','HPC11') then
--                                                 'HPC'
--                                            else
--                                                 a.med_dept
--                                       end
--                                     )
                               rollup(a.med_dept)
                      having  case when sum(a.o_cnt) = 0 then 0 else trunc(sum(a.o_cnt)/c.daycnt_all) end
                              +
                              case when sum(a.i_cnt) = 0 then 0 else trunc(sum(a.i_cnt)/b.daycnt_all) end  != 0
                    )
             )
                                ;
        elsif in_srchtyp = '3' then
                        open wk_cursor for
       select
              case when group_ing = '00' then --rank = 1 and
                        med_dept_nm
                   when group_ing = '11' then
                        '합계'
                   else  null
              end        med_dept_nm
             ,meddr_id
             ,cntall
             ,cnt01
             ,cnt02
             ,cnt03
             ,cnt04
             ,cnt05
             ,cnt06
             ,cnt07
             ,cnt08
             ,cnt09
             ,cnt10
             ,cnt11
             ,cnt12
         from
             (
              select
                     nvl((select
                                           dept_nm
                            from ccdepart a
                           where dept_cd = med_dept),med_dept)  med_dept_nm
                    ,meddr_id
                    ,cntall
                    ,cnt01
                    ,cnt02
                    ,cnt03
                    ,cnt04
                    ,cnt05
                    ,cnt06
                    ,cnt07
                    ,cnt08
                    ,cnt09
                    ,cnt10
                    ,cnt11
                    ,cnt12
                    ,group_ing
                    ,row_number() over (partition by   nvl((select
                                                                             dept_nm
                                                              from ccdepart a
                                                             where dept_cd = med_dept),med_dept)
                                            order by   meddr_id
                                       ) rank
                from
                    (
                     --------------------------------------------------------------------------------------
                     -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 추가함..
                     --------------------------------------------------------------------------------------
                     select
                            med_dept                                                               med_dept
                           ,nvl((select wk_nm   from ccusermt a where wk_id = meddr_id),meddr_id)  meddr_id
                           ,cntall                                                                 cntall
                           ,cnt01                                                                  cnt01
                           ,cnt02                                                                  cnt02
                           ,cnt03                                                                  cnt03
                           ,cnt04                                                                  cnt04
                           ,cnt05                                                                  cnt05
                           ,cnt06                                                                  cnt06
                           ,cnt07                                                                  cnt07
                           ,cnt08                                                                  cnt08
                           ,cnt09                                                                  cnt09
                           ,cnt10                                                                  cnt10
                           ,cnt11                                                                  cnt11
                           ,cnt12                                                                  cnt12
                           ,group_ing                                                              group_ing
                       from (
                             select
                                    a.med_dept                                                   med_dept
                                   ,nvl(b.lst_wk_id,a.meddr_id)                                  meddr_id
                                   ,sum(a.cntall)                                                cntall
                                   ,sum(a.cnt01 )                                                cnt01
                                   ,sum(a.cnt02 )                                                cnt02
                                   ,sum(a.cnt03 )                                                cnt03
                                   ,sum(a.cnt04 )                                                cnt04
                                   ,sum(a.cnt05 )                                                cnt05
                                   ,sum(a.cnt06 )                                                cnt06
                                   ,sum(a.cnt07 )                                                cnt07
                                   ,sum(a.cnt08 )                                                cnt08
                                   ,sum(a.cnt09 )                                                cnt09
                                   ,sum(a.cnt10 )                                                cnt10
                                   ,sum(a.cnt11 )                                                cnt11
                                   ,sum(a.cnt12 )                                                cnt12
                                   ,grouping(a.med_dept)||grouping(nvl(b.lst_wk_id,a.meddr_id))  group_ing
                               from (
                                     select
                                            a.med_dept                                                   med_dept
                                            --------------------------------------------------------------------------------------
                                            -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 이 logic 막고.. meddr_id 그냥 사용
                                            --------------------------------------------------------------------------------------
                                           ,a.meddr_id                                                   meddr_id
                                            --------------------------------------------------------------------------------------
                                            -- 수정전 logic
                                            --------------------------------------------------------------------------------------
                                           --,nvl((select wk_nm   from ccusermt a where wk_id = meddr_id),meddr_id)  meddr_id --||' '||meddr_id
                                            --------------------------------------------------------------------------------------
                                           ,sum(a.o_cnt+a.i_cnt)                                          cntall
                                           ,sum(case when to_char(a.med_dte,'mm') = '01'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt01
                                           ,sum(case when to_char(a.med_dte,'mm') = '02'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt02
                                           ,sum(case when to_char(a.med_dte,'mm') = '03'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt03
                                           ,sum(case when to_char(a.med_dte,'mm') = '04'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt04
                                           ,sum(case when to_char(a.med_dte,'mm') = '05'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt05
                                           ,sum(case when to_char(a.med_dte,'mm') = '06'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt06
                                           ,sum(case when to_char(a.med_dte,'mm') = '07'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt07
                                           ,sum(case when to_char(a.med_dte,'mm') = '08'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt08
                                           ,sum(case when to_char(a.med_dte,'mm') = '09'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt09
                                           ,sum(case when to_char(a.med_dte,'mm') = '10'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt10
                                           ,sum(case when to_char(a.med_dte,'mm') = '11'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt11
                                           ,sum(case when to_char(a.med_dte,'mm') = '12'  then
                                                          a.o_cnt+a.i_cnt
                                                     else  0 end)                                        cnt12
                                            --------------------------------------------------------------------------------------
                                            -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 이 logic 막는다
                                            --------------------------------------------------------------------------------------
                                           --,grouping(a.med_dept)||grouping(a.meddr_id)    group_ing
                                       from
                                            (
                                             select
                                                    med_dte
                                                   ,med_dept
                                                   ,meddr_id
                                                   ,case in_selyn
                                                         when '1' then
                                                              chspcrsv_cnt+jespcrsv_cnt+shrsv_cnt
                                                         when '2' then
                                                              chunspcrsv_cnt+jeunspcrsv_cnt+shunspcrsv_cnt
                                                         else
                                                              rsv_cnt+today_cnt
                                                    end                      o_cnt
                                                   ,0                        i_cnt
                                              from apstatmt2
                                                  ,(
                                                    select to_date(in_yyyy||'0101','yyyymmdd')  star_dte
                                                          ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                                     last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                                else
                                                                     trunc(sysdate)-1
                                                           end end_dte
                                                      from dual
                                                   )
                                             where med_dte between star_dte  and  end_dte
                                               and dtl_typ = '06'
                                               and patsite in ('O','E')
                                               and case when in_look = '1' then '1'
                                                        when in_look = '2' then 'X'
                                                        else in_look
                                                   end  =  in_look
                                             union all
                                             select
                                                   med_dte
                                                  ,med_dept
                                                  ,meddr_id
                                                  ,0               o_cnt
                                                  ,case in_selyn
                                                        when '1' then
                                                             jespcrcp_cnt
                                                        when '2' then
                                                             jeunspcrcp_cnt
                                                        else
                                                             jespcrsv_cnt
                                                   end
                                              from apstatmt2
                                             where med_dte in (
                                                               select
                                                                      distinct
                                                                      case when last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd')) <= trunc(sysdate) -1  then
                                                                                last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd'))
                                                                           else
                                                                                trunc(sysdate) -1
                                                                      end
                                                                 from dict
                                                                where rownum <= 12
                                                              )
                                               and dtl_typ = 'M01'
                                               and patsite = 'I'
                                               and wk_key  = '1'
                                               and case when in_look = '1' then 'X'
                                                        when in_look = '2' then '2'
                                                        else in_look
                                                   end  =  in_look
                                            ) a
                                       -------------------------------------------------------------------------------------------
                                       -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 rollup 제거및 having 조건 제거
                                       -------------------------------------------------------------------------------------------
                                       group by
                                             a.med_dept
                                            ,a.meddr_id
                                       having sum(a.o_cnt+a.i_cnt) != 0
                                       -------------------------------------------------------------------------------------------
                                       -- 수정전 logic
                                       -------------------------------------------------------------------------------------------
                                       --group by
                                       --        rollup( a.med_dept
                                       --               ,a.meddr_id
                                       --               )
                                       --having    sum(a.o_cnt+a.i_cnt) != 0
                                       --     and grouping(a.med_dept)||grouping(a.meddr_id) in ('00','11')
                                       -------------------------------------------------------------------------------------------
                                    )       a
                                  , ccusermt  b
                              where b.wk_id(+) = nvl(a.meddr_id,'*')
                              group by
                                    rollup(a.med_dept,nvl(b.lst_wk_id,a.meddr_id))
                             having sum(a.cntall) != 0
                                and grouping(a.med_dept)||grouping(nvl(b.lst_wk_id,a.meddr_id)) in ('00','11')
                            )
                    )
             )
                                ;
        elsif in_srchtyp = '4' then
                        open wk_cursor for
       select
              case when group_ing = '00' then--rank = 1 and
                        med_dept_nm
                   when group_ing = '11' then
                        '합계'
                   else  null
              end        med_dept_nm
             ,meddr_id
             ,cntall
             ,cnt01
             ,cnt02
             ,cnt03
             ,cnt04
             ,cnt05
             ,cnt06
             ,cnt07
             ,cnt08
             ,cnt09
             ,cnt10
             ,cnt11
             ,cnt12
         from
             (
              select
                     nvl((select
                                           dept_nm
                            from ccdepart a
                           where dept_cd = med_dept),med_dept)  med_dept_nm
                    ,meddr_id
                    ,cntall
                    ,cnt01
                    ,cnt02
                    ,cnt03
                    ,cnt04
                    ,cnt05
                    ,cnt06
                    ,cnt07
                    ,cnt08
                    ,cnt09
                    ,cnt10
                    ,cnt11
                    ,cnt12
                    ,group_ing
                    ,row_number() over (partition by   nvl((select
                                                                             dept_nm
                                                              from ccdepart a
                                                             where dept_cd = med_dept),med_dept)
                                            order by   meddr_id
                                       ) rank
                from
                    (
                     --------------------------------------------------------------------------------------
                     -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 추가함..
                     --------------------------------------------------------------------------------------
                     select
                            med_dept                                                               med_dept
                           ,nvl((select wk_nm   from ccusermt a where wk_id = meddr_id),meddr_id)  meddr_id
                           ,cntall                                                                 cntall
                           ,cnt01                                                                  cnt01
                           ,cnt02                                                                  cnt02
                           ,cnt03                                                                  cnt03
                           ,cnt04                                                                  cnt04
                           ,cnt05                                                                  cnt05
                           ,cnt06                                                                  cnt06
                           ,cnt07                                                                  cnt07
                           ,cnt08                                                                  cnt08
                           ,cnt09                                                                  cnt09
                           ,cnt10                                                                  cnt10
                           ,cnt11                                                                  cnt11
                           ,cnt12                                                                  cnt12
                           ,group_ing                                                              group_ing
                       from (
                             select
                                    a.med_dept                                                            med_dept
                                    --------------------------------------------------------------------------------------
                                    -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 수정
                                    --------------------------------------------------------------------------------------
                                   ,nvl(d.lst_wk_id,a.meddr_id)                                           meddr_id
                                    --------------------------------------------------------------------------------------
                                    --수정전 logic
                                    --------------------------------------------------------------------------------------
                                    --,nvl((select wk_nm   from ccusermt a where wk_id = meddr_id),meddr_id) meddr_id
                                    --------------------------------------------------------------------------------------
                                   ,
                                     case when sum(a.o_cnt) = 0 then 0 else round(sum(a.o_cnt)/c.daycnt_all) end
                                     +
                                     case when sum(a.i_cnt) = 0 then 0 else round(sum(a.i_cnt)/b.daycnt_all) end      cntall
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '01' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '01'  then a.o_cnt else 0 end)/c.daycnt1)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '01' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '01'  then a.i_cnt else 0 end)/b.daycnt1)
                                     end                                                           cnt01
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '02' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '02'  then a.o_cnt else 0 end)/c.daycnt2)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '02' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '02'  then a.i_cnt else 0 end)/b.daycnt2)
                                     end                                                           cnt02
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '03' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '03'  then a.o_cnt else 0 end)/c.daycnt3)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '03' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '03'  then a.i_cnt else 0 end)/b.daycnt3)
                                     end                                                           cnt03
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '04' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '04'  then a.o_cnt else 0 end)/c.daycnt4)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '04' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '04'  then a.i_cnt else 0 end)/b.daycnt4)
                                     end                                                           cnt04
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '05' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '05'  then a.o_cnt else 0 end)/c.daycnt5)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '05' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '05'  then a.i_cnt else 0 end)/b.daycnt5)
                                     end                                                           cnt05
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '06' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '06'  then a.o_cnt else 0 end)/c.daycnt6)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '06' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '06'  then a.i_cnt else 0 end)/b.daycnt6)
                                     end                                                           cnt06
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '07' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '07'  then a.o_cnt else 0 end)/c.daycnt7)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '07' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '07'  then a.i_cnt else 0 end)/b.daycnt7)
                                     end                                                           cnt07
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '08' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '08'  then a.o_cnt else 0 end)/c.daycnt8)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '08' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '08'  then a.i_cnt else 0 end)/b.daycnt8)
                                     end                                                           cnt08
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '09' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '09'  then a.o_cnt else 0 end)/c.daycnt9)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '09' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '09'  then a.i_cnt else 0 end)/b.daycnt9)
                                     end                                                           cnt09
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '10' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '10'  then a.o_cnt else 0 end)/c.daycnt10)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '10' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '10'  then a.i_cnt else 0 end)/b.daycnt10)
                                     end                                                           cnt10
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '11' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '11'  then a.o_cnt else 0 end)/c.daycnt11)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '11' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '11'  then a.i_cnt else 0 end)/b.daycnt11)
                                     end                                                           cnt11
                                   ,
                                     case when sum(case when to_char(a.med_dte,'mm') = '12' then a.o_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '12'  then a.o_cnt else 0 end)/c.daycnt12)
                                     end
                                     +
                                     case when sum(case when to_char(a.med_dte,'mm') = '12' then a.i_cnt else 0 end) = 0 then
                                               0
                                          else round(sum(case when to_char(a.med_dte,'mm') = '12'  then a.i_cnt else 0 end)/b.daycnt12)
                                     end                                                           cnt12
                                    --------------------------------------------------------------------------------------
                                    -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 수정
                                    --------------------------------------------------------------------------------------
                                   ,grouping(a.med_dept)||grouping(nvl(d.lst_wk_id,a.meddr_id))  group_ing
                                    --------------------------------------------------------------------------------------
                                    -- 수정전 logic
                                    --------------------------------------------------------------------------------------
                                   --,grouping(a.med_dept)||grouping(a.meddr_id)    group_ing
                                    --------------------------------------------------------------------------------------
                               from
                                    (
                                     select
                                            med_dte
                                           ,med_dept
                                           ,meddr_id
                                           ,case in_selyn
                                                 when '1' then
                                                      chspcrsv_cnt+jespcrsv_cnt+shrsv_cnt
                                                 when '2' then
                                                      chunspcrsv_cnt+jeunspcrsv_cnt+shunspcrsv_cnt
                                                 else
                                                      rsv_cnt+today_cnt
                                            end                      o_cnt
                                           ,0                        i_cnt
                                      from apstatmt2
                                          ,(
                                            select to_date(in_yyyy||'0101','yyyymmdd')  star_dte
                                                  ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                             last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                        else
                                                             trunc(sysdate)-1
                                                   end end_dte
                                              from dual
                                           )
                                     where med_dte between star_dte  and  end_dte
                                       and dtl_typ = '06'
                                       and patsite in ('O','E')
                                       and case when in_look = '1' then '1'
                                                when in_look = '2' then 'X'
                                                else in_look
                                           end  =  in_look
                                     union all
                                     select
                                           med_dte
                                          ,med_dept
                                          ,meddr_id
                                          ,0               o_cnt
                                          ,case in_selyn
                                                when '1' then
                                                     jespcrcp_cnt
                                                when '2' then
                                                     jeunspcrcp_cnt
                                                else
                                                     jespcrsv_cnt
                                           end
                                      from apstatmt2
                                     where med_dte in (
                                                       select
                                                              distinct
                                                              case when last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd')) <= trunc(sysdate) -1  then
                                                                        last_day(to_date(in_yyyy||lpad(rownum,2,'0')||'01','yyyymmdd'))
                                                                   else
                                                                        trunc(sysdate) -1
                                                              end
                                                         from dict
                                                        where rownum <= 12
                                                      )
                                       and dtl_typ = 'M01'
                                       and patsite = 'I'
                                       and wk_key  = '1'
                                       and case when in_look = '1' then 'X'
                                                when in_look = '2' then '2'
                                                else in_look
                                           end  =  in_look
                                    ) a
                                    ,
                                    (
                                     select
                                             ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt_all
                                            ,ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0101','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0101','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt1
                                           ,ft_cnt_opday(to_date(in_yyyy||'0201','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0201','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0201','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt2
                                           ,ft_cnt_opday(to_date(in_yyyy||'0301','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0301','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0301','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt3
                                           ,ft_cnt_opday(to_date(in_yyyy||'0401','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0401','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0401','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt4
                                           ,ft_cnt_opday(to_date(in_yyyy||'0501','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0501','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0501','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt5
                                           ,ft_cnt_opday(to_date(in_yyyy||'0601','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0601','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0601','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt6
                                           ,ft_cnt_opday(to_date(in_yyyy||'0701','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0701','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0701','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt7
                                           ,ft_cnt_opday(to_date(in_yyyy||'0801','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0801','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0801','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt8
                                           ,ft_cnt_opday(to_date(in_yyyy||'0901','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0901','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0901','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt9
                                           ,ft_cnt_opday(to_date(in_yyyy||'1001','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1001','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1001','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt10
                                           ,ft_cnt_opday(to_date(in_yyyy||'1101','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1101','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1101','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt11
                                           ,ft_cnt_opday(to_date(in_yyyy||'1201','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'1')               daycnt12
                                       from
                                            dual
                                     ) b
                                    ,
                                    (
                                     select
                                            ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt_all
                                           ,ft_cnt_opday(to_date(in_yyyy||'0101','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0101','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0101','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt1
                                           ,ft_cnt_opday(to_date(in_yyyy||'0201','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0201','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0201','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt2
                                           ,ft_cnt_opday(to_date(in_yyyy||'0301','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0301','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0301','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt3
                                           ,ft_cnt_opday(to_date(in_yyyy||'0401','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0401','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0401','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt4
                                           ,ft_cnt_opday(to_date(in_yyyy||'0501','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0501','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0501','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt5
                                           ,ft_cnt_opday(to_date(in_yyyy||'0601','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0601','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0601','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt6
                                           ,ft_cnt_opday(to_date(in_yyyy||'0701','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0701','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0701','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt7
                                           ,ft_cnt_opday(to_date(in_yyyy||'0801','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0801','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0801','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt8
                                           ,ft_cnt_opday(to_date(in_yyyy||'0901','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'0901','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'0901','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt9
                                           ,ft_cnt_opday(to_date(in_yyyy||'1001','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1001','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1001','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt10
                                           ,ft_cnt_opday(to_date(in_yyyy||'1101','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1101','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1101','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt11
                                           ,ft_cnt_opday(to_date(in_yyyy||'1201','yyyymmdd')
                                                        ,case when last_day(to_date(in_yyyy||'1201','yyyymmdd')) < trunc(sysdate)-1  then
                                                                   last_day(to_date(in_yyyy||'1201','yyyymmdd'))
                                                              else
                                                                   trunc(sysdate)-1
                                                         end
                                                        ,'3')               daycnt12
                                       from
                                            dual
                                    ) c
                               -------------------------------------------------------------------------------------------
                               -- 2010.05.18 동일의사인 경우 최종사번으로 합쳐 나오게 하기 위해 logic 수정
                               -------------------------------------------------------------------------------------------
                                   , ccusermt d
                               where d.wk_id(+) = nvl(a.meddr_id,'*')
                               group by
                                     rollup(a.med_dept,nvl(d.lst_wk_id,a.meddr_id))
                              having case when sum(a.o_cnt) = 0 then 0 else trunc(sum(a.o_cnt)/c.daycnt_all) end
                                     +
                                     case when sum(a.i_cnt) = 0 then 0 else trunc(sum(a.i_cnt)/b.daycnt_all) end  != 0
                                 and grouping(a.med_dept)||grouping(nvl(d.lst_wk_id,a.meddr_id)) in ('00','11')
                               -------------------------------------------------------------------------------------------
                               -- 수정전 logic
                               -------------------------------------------------------------------------------------------
                               --group by
                               --        rollup(
                               --                a.med_dept
                               --               ,a.meddr_id
                               --              )
                               --having  case when sum(a.o_cnt) = 0 then 0 else trunc(sum(a.o_cnt)/c.daycnt_all) end
                               --       +
                               --       case when sum(a.i_cnt) = 0 then 0 else trunc(sum(a.i_cnt)/b.daycnt_all) end  != 0
                               --     and grouping(a.med_dept)||grouping(a.meddr_id) in ('00','11')
                               -------------------------------------------------------------------------------------------
                            )
                    )
             )
                                ;
        end if;
--
        out_cursor := wk_cursor;

        exception
            when others then
                raise_application_error(-20500,'pc_sel_pts02_income020 오류!' || chr(13) || 'err_cd = '|| sqlcode || chr(13) || ' ' || sqlerrm);


    end pc_sel_pts02_income020;
```


## 코드 변환

in_srchtyp  in   varchar2   --      '1': 진료과별 환자현황, '2': 진료과별 일평균 환자수, '3': 진료과별/의사별 환자현황, '4': 진료과별/의사별 일평균 환자수
in_yyyy     in   varchar2
in_selyn    in   varchar2  -- '1' 선택 ,'2' 비선택 ,else 전체
in_look     in   varchar2  --'1' 외래 ,'2' 입원  ,3 전체



EXEC :in_srchtyp := 'in';
EXEC :in_yyyy := 'in';
EXEC :in_selyn := 'in';
EXEC :in_look := 'in';
